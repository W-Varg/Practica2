name: DevSecOps CI/CD Pipeline
on:
  push:
    branches: [ "main" ]
  pull_request:
jobs:
  devsecops:
    runs-on: ubuntu-latest
    steps:
    # =========================
    # 1. Checkout
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # 2. Setup Node
    # =========================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # =========================
    # 5.5 Create .env files (CI)
    # =========================
    - name: Create env files for Docker Compose
      run: |
        # Backend services
        cp backend/users-service/.env.example backend/users-service/.env
        cp backend/academic-service/.env.example backend/academic-service/.env
        cp backend/api-gateway/.env.example backend/api-gateway/.env

        echo "DB_HOST=${{ secrets.USERS_DB_HOST }}" >> backend/users-service/.env
        echo "DB_USER=${{ secrets.USERS_DB_USER }}" >> backend/users-service/.env
        echo "DB_PASSWORD=${{ secrets.USERS_DB_PASSWORD }}" >> backend/users-service/.env

        echo "DB_HOST=${{ secrets.ACADEMIC_DB_HOST }}" >> backend/academic-service/.env
        echo "DB_USER=${{ secrets.ACADEMIC_DB_USER }}" >> backend/academic-service/.env
        echo "DB_PASSWORD=${{ secrets.ACADEMIC_DB_PASSWORD }}" >> backend/academic-service/.env

        echo "USERS_SERVICE_URL=http://users-service:3001" >> backend/api-gateway/.env
        echo "ACADEMIC_SERVICE_URL=http://academic-service:3002" >> backend/api-gateway/.env
        # Frontend (build/test time)
        cp frontend/.env.example frontend/.env
        echo "VITE_API_URL=http://api-gateway:3000" >> frontend/.env
    # =========================
    # 3. Install & Test Backend
    # =========================
    - name: Install & Test users-service
      run: |
        cd backend/users-service
        npm ci
        npm test

    - name: Install & Test academic-service
      run: |
        cd backend/academic-service
        npm ci
        npm test

    - name: Install & Test api-gateway
      run: |
        cd backend/api-gateway
        npm ci
        npm test

    # =========================
    # 4. Install & Test Frontend
    # =========================
    - name: Install & Test frontend
      run: |
        cd frontend
        npm ci
        npm test

    # =========================
    # 4.5 ESLint – Calidad de código
    # =========================
    - name: ESLint – frontend
      run: |
        cd frontend
        npm run lint

    # =========================
    # 5. SAST – Semgrep
    # =========================
    - name: Install Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: SAST users-service
      run: |
        cd backend/users-service
        semgrep --config=auto --severity=ERROR --json --output=semgrep-users.json || true
        semgrep --config=auto --severity=ERROR

    - name: SAST academic-service
      run: |
        cd backend/academic-service
        semgrep --config=auto --severity=ERROR --json --output=semgrep-academic.json || true
        semgrep --config=auto --severity=ERROR

    - name: SAST api-gateway
      run: |
        cd backend/api-gateway
        semgrep --config=auto --severity=ERROR --json --output=semgrep-gateway.json || true
        semgrep --config=auto --severity=ERROR

    - name: SAST frontend
      run: |
        cd frontend
        semgrep --config=auto --severity=ERROR --json --output=semgrep-frontend.json || true
        semgrep --config=auto --severity=ERROR

    - name: Upload Semgrep reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-reports
        path: |
          backend/users-service/semgrep-users.json
          backend/academic-service/semgrep-academic.json
          backend/api-gateway/semgrep-gateway.json
          frontend/semgrep-frontend.json

    - name: Validate env files
      run: |
        ls -la backend/users-service
        ls -la backend/academic-service
        ls -la backend/api-gateway
        ls -la frontend

    # =========================
    # 6. Docker Build + Versionado
    # =========================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: |
        docker compose -f backend/docker-compose.yml build

    - name: Tag Docker images with commit SHA (versionado)
      run: |
        SHA=${{ github.sha }}
        SHORT_SHA=${SHA::8}
        docker tag users-service    users-service:${SHORT_SHA}
        docker tag academic-service academic-service:${SHORT_SHA}
        docker tag api-gateway      api-gateway:${SHORT_SHA}
        docker tag frontend         frontend:${SHORT_SHA}
        echo "Images tagged with version: ${SHORT_SHA}"
        docker images | grep -E "users-service|academic-service|api-gateway|frontend"

    # =========================
    # 7. SCA + Seguridad de contenedores – Trivy
    # =========================
    - name: Trivy scan users-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: users-service
        severity: HIGH,CRITICAL
        exit-code: 1
        ignore-unfixed: true
        format: table
        output: trivy-users.txt

    - name: Trivy scan academic-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: academic-service
        severity: HIGH,CRITICAL
        exit-code: 1
        ignore-unfixed: true
        format: table
        output: trivy-academic.txt

    - name: Trivy scan api-gateway
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: api-gateway
        severity: HIGH,CRITICAL
        exit-code: 1
        ignore-unfixed: true
        format: table
        output: trivy-gateway.txt

    - name: Trivy scan frontend
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: frontend
        severity: HIGH,CRITICAL
        exit-code: 1
        ignore-unfixed: true
        format: table
        output: trivy-frontend.txt

    - name: Trivy scan frontend
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: frontend
        severity: HIGH,CRITICAL
        exit-code: 1
        format: table
        output: trivy-frontend.txt

    - name: Upload Trivy reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-reports
        path: |
          trivy-users.txt
          trivy-academic.txt
          trivy-gateway.txt
          trivy-frontend.txt

    # =========================
    # 8. Smoke test
    # =========================
    - name: Run docker-compose
      run: |
        docker compose -f backend/docker-compose.yml up -d
        sleep 15

    - name: Smoke test API Gateway
      run: |
        curl http://localhost:3000/health

    - name: Shutdown services
      if: always()
      run: docker compose -f backend/docker-compose.yml down || true